{% extends 'base_dashboard.html' %}

{% block title %}Admin Management - KillShill{% endblock %}
{% block page_title %}Admin Management{% endblock %}

{% block page_subtitle %}
<p class="page-subtitle">Comprehensive submission management and auto-approval system control</p>
{% endblock %}

{% block extra_css %}
{{ block.super }}
<style>
    .admin-card {
        border: 1px solid var(--gray-200);
        border-radius: var(--radius-xl);
        background: white;
        overflow: hidden;
        transition: all 0.3s ease;
    }
    
    .admin-card:hover {
        box-shadow: var(--shadow-lg);
        transform: translateY(-2px);
    }
    
    .admin-card-header {
        background: linear-gradient(135deg, var(--gray-50), var(--gray-100));
        border-bottom: 1px solid var(--gray-200);
        padding: 1.25rem 1.5rem;
    }
    
    .admin-card-title {
        font-size: 1.125rem;
        font-weight: 600;
        color: var(--gray-800);
        margin: 0;
    }
    
    .admin-card-subtitle {
        color: var(--gray-600);
        font-size: 0.875rem;
        margin: 0;
    }
    
    .system-status-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 1.5rem;
        margin-bottom: 2rem;
    }
    
    .status-item {
        display: flex;
        justify-content: between;
        align-items: center;
        padding: 1rem 0;
        border-bottom: 1px solid var(--gray-100);
    }
    
    .status-item:last-child {
        border-bottom: none;
    }
    
    .status-label {
        color: var(--gray-600);
        font-weight: 500;
    }
    
    .status-value {
        margin-left: auto;
        font-weight: 600;
    }
    
    .status-indicator-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        margin-left: 0.5rem;
    }
    
    .status-indicator-dot.online {
        background-color: var(--success);
        animation: pulse-green 2s infinite;
    }
    
    .status-indicator-dot.warning {
        background-color: var(--warning);
    }
    
    .status-indicator-dot.offline {
        background-color: var(--danger);
    }
    
    @keyframes pulse-green {
        0% { opacity: 1; }
        50% { opacity: 0.5; }
        100% { opacity: 1; }
    }
    
    .action-button {
        width: 100%;
        padding: 0.875rem 1rem;
        border: 1px solid var(--gray-300);
        border-radius: var(--radius-lg);
        background: white;
        color: var(--gray-700);
        font-weight: 500;
        transition: all 0.2s ease;
        cursor: pointer;
        text-align: left;
        display: flex;
        align-items: center;
        gap: 0.75rem;
        margin-bottom: 0.75rem;
    }
    
    .action-button:hover {
        border-color: var(--primary);
        background-color: rgba(37, 99, 235, 0.05);
        color: var(--primary);
    }
    
    .action-button.destructive:hover {
        border-color: var(--danger);
        background-color: rgba(239, 68, 68, 0.05);
        color: var(--danger);
    }
    
    .action-icon {
        width: 20px;
        text-align: center;
    }
    
    .data-table {
        font-size: 0.875rem;
    }
    
    .data-table th {
        background-color: var(--gray-50);
        border-color: var(--gray-200);
        font-weight: 600;
        color: var(--gray-700);
        padding: 0.875rem;
        font-size: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }
    
    .data-table td {
        padding: 0.875rem;
        border-color: var(--gray-200);
        vertical-align: middle;
    }
    
    .data-table tbody tr:hover {
        background-color: var(--gray-50);
    }
    
    .bulk-actions {
        background: var(--gray-50);
        border: 1px solid var(--gray-200);
        border-radius: var(--radius-lg);
        padding: 1rem;
        margin-bottom: 1rem;
        display: none;
    }
    
    .bulk-actions.show {
        display: block;
    }
    
    .select-all-checkbox {
        margin-right: 0.5rem;
    }
    
    .processing-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 9999;
        display: none;
    }
    
    .processing-overlay.show {
        display: flex;
    }
    
    .processing-content {
        background: white;
        border-radius: var(--radius-xl);
        padding: 2rem;
        text-align: center;
        max-width: 400px;
        margin: 1rem;
    }
    
    .processing-spinner {
        width: 48px;
        height: 48px;
        border: 4px solid var(--gray-200);
        border-top: 4px solid var(--primary);
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 0 auto 1rem;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    .log-viewer {
        background: var(--gray-900);
        color: var(--gray-100);
        border-radius: var(--radius-lg);
        padding: 1rem;
        font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
        font-size: 0.75rem;
        line-height: 1.4;
        max-height: 400px;
        overflow-y: auto;
        white-space: pre-wrap;
    }
    
    .metric-card {
        text-align: center;
        padding: 1.5rem;
        border-radius: var(--radius-lg);
        background: white;
        border: 1px solid var(--gray-200);
    }
    
    .metric-value {
        font-size: 2rem;
        font-weight: 700;
        margin-bottom: 0.5rem;
        color: var(--gray-900);
    }
    
    .metric-label {
        color: var(--gray-600);
        font-size: 0.875rem;
        font-weight: 500;
    }
    
    .metric-change {
        font-size: 0.75rem;
        margin-top: 0.25rem;
    }
    
    .metric-change.positive {
        color: var(--success);
    }
    
    .metric-change.negative {
        color: var(--danger);
    }
    
    .config-form {
        background: var(--gray-50);
        border-radius: var(--radius-lg);
        padding: 1.5rem;
        margin-top: 1rem;
    }
    
    .config-section {
        margin-bottom: 1.5rem;
    }
    
    .config-section:last-child {
        margin-bottom: 0;
    }
    
    .config-section-title {
        font-weight: 600;
        color: var(--gray-800);
        margin-bottom: 0.75rem;
        font-size: 0.875rem;
    }
</style>
{% endblock %}

{% block content %}
<!-- System Overview -->
<div class="system-status-grid">
    <!-- System Health -->
    <div class="admin-card">
        <div class="admin-card-header">
            <h5 class="admin-card-title">System Health</h5>
            <p class="admin-card-subtitle">Auto-approval system status</p>
        </div>
        <div class="card-body">
            <div class="status-item">
                <span class="status-label">System Status</span>
                <div class="status-value">
                    Online
                    <span class="status-indicator-dot online"></span>
                </div>
            </div>
            <div class="status-item">
                <span class="status-label">Processing Queue</span>
                <div class="status-value" id="queueStatus">0 pending</div>
            </div>
            <div class="status-item">
                <span class="status-label">API Status</span>
                <div class="status-value">
                    <span class="badge badge-success">Connected</span>
                </div>
            </div>
            <div class="status-item">
                <span class="status-label">Last Process</span>
                <div class="status-value" id="lastProcessTime">Just now</div>
            </div>
        </div>
    </div>
    
    <!-- Today's Metrics -->
    <div class="admin-card">
        <div class="admin-card-header">
            <h5 class="admin-card-title">Today's Metrics</h5>
            <p class="admin-card-subtitle">Processing statistics</p>
        </div>
        <div class="card-body">
            <div class="row g-3">
                <div class="col-6">
                    <div class="metric-card border-0 bg-light">
                        <div class="metric-value text-success" id="approvedToday">0</div>
                        <div class="metric-label">Approved</div>
                        <div class="metric-change positive">+0 vs yesterday</div>
                    </div>
                </div>
                <div class="col-6">
                    <div class="metric-card border-0 bg-light">
                        <div class="metric-value text-warning" id="pendingToday">0</div>
                        <div class="metric-label">Pending</div>
                        <div class="metric-change">0 in queue</div>
                    </div>
                </div>
                <div class="col-6">
                    <div class="metric-card border-0 bg-light">
                        <div class="metric-value text-info" id="processedToday">0</div>
                        <div class="metric-label">Processed</div>
                        <div class="metric-change positive">+0 total</div>
                    </div>
                </div>
                <div class="col-6">
                    <div class="metric-card border-0 bg-light">
                        <div class="metric-value text-primary" id="accuracyRate">100%</div>
                        <div class="metric-label">Accuracy</div>
                        <div class="metric-change positive">High quality</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Quick Actions -->
    <div class="admin-card">
        <div class="admin-card-header">
            <h5 class="admin-card-title">Quick Actions</h5>
            <p class="admin-card-subtitle">System management tools</p>
        </div>
        <div class="card-body">
            <button class="action-button" onclick="processAllPending()">
                <i class="fas fa-play action-icon"></i>
                Process All Pending
            </button>
            <button class="action-button" onclick="showBulkManagement()">
                <i class="fas fa-tasks action-icon"></i>
                Bulk Management
            </button>
            <button class="action-button" onclick="showSystemLogs()">
                <i class="fas fa-file-alt action-icon"></i>
                View System Logs
            </button>
            <button class="action-button" onclick="showConfiguration()">
                <i class="fas fa-cog action-icon"></i>
                System Configuration
            </button>
            <button class="action-button" onclick="exportData()">
                <i class="fas fa-download action-icon"></i>
                Export Data
            </button>
            <button class="action-button destructive" onclick="clearRejectedSubmissions()">
                <i class="fas fa-trash action-icon"></i>
                Clear Rejected (30d+)
            </button>
        </div>
    </div>
</div>

<!-- Bulk Management Section -->
<div class="admin-card mb-4" id="bulkManagementSection" style="display: none;">
    <div class="admin-card-header">
        <h5 class="admin-card-title">Bulk Submission Management</h5>
        <p class="admin-card-subtitle">Select and manage multiple submissions</p>
    </div>
    <div class="card-body">
        <!-- Bulk Actions Bar -->
        <div class="bulk-actions" id="bulkActionsBar">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <span id="selectedCount">0</span> submissions selected
                </div>
                <div class="d-flex gap-2">
                    <button class="btn btn-success btn-sm" onclick="bulkApprove()">
                        <i class="fas fa-check"></i> Approve Selected
                    </button>
                    <button class="btn btn-warning btn-sm" onclick="bulkReject()">
                        <i class="fas fa-times"></i> Reject Selected
                    </button>
                    <button class="btn btn-primary btn-sm" onclick="bulkProcess()">
                        <i class="fas fa-cog"></i> Process Selected
                    </button>
                    <button class="btn btn-outline-secondary btn-sm" onclick="clearSelection()">
                        Clear Selection
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Submissions Table -->
        <div class="table-responsive">
            <table class="table data-table" id="submissionsTable">
                <thead>
                    <tr>
                        <th>
                            <input type="checkbox" class="form-check-input" id="selectAllCheckbox" onchange="toggleSelectAll()">
                        </th>
                        <th>ID</th>
                        <th>Influencer</th>
                        <th>Platform</th>
                        <th>Status</th>
                        <th>Score</th>
                        <th>Submitted</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="submissionsTableBody">
                    <!-- Data will be loaded here -->
                </tbody>
            </table>
        </div>
        
        <!-- Pagination -->
        <nav class="d-flex justify-content-between align-items-center mt-3">
            <div class="text-muted">
                Showing <span id="showingStart">0</span> to <span id="showingEnd">0</span> of <span id="totalSubmissions">0</span> submissions
            </div>
            <ul class="pagination pagination-sm mb-0" id="pagination">
                <!-- Pagination will be generated here -->
            </ul>
        </nav>
    </div>
</div>

<!-- System Logs Modal -->
<div class="modal fade" id="systemLogsModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">System Logs</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <div class="btn-group" role="group">
                        <input type="radio" class="btn-check" name="logType" id="autoApprovalLogs" value="auto_approval" checked>
                        <label class="btn btn-outline-primary btn-sm" for="autoApprovalLogs">Auto-Approval</label>
                        
                        <input type="radio" class="btn-check" name="logType" id="verificationLogs" value="verification">
                        <label class="btn btn-outline-primary btn-sm" for="verificationLogs">Verification</label>
                        
                        <input type="radio" class="btn-check" name="logType" id="systemLogs" value="system">
                        <label class="btn btn-outline-primary btn-sm" for="systemLogs">System</label>
                    </div>
                    <div class="d-flex gap-2">
                        <button class="btn btn-outline-secondary btn-sm" onclick="refreshLogs()">
                            <i class="fas fa-sync-alt"></i> Refresh
                        </button>
                        <button class="btn btn-outline-primary btn-sm" onclick="downloadLogs()">
                            <i class="fas fa-download"></i> Download
                        </button>
                    </div>
                </div>
                <div class="log-viewer" id="logViewer">
                    Loading logs...
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Configuration Modal -->
<div class="modal fade" id="configurationModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">System Configuration</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="configurationForm" class="config-form">
                    <div class="config-section">
                        <div class="config-section-title">Auto-Approval Thresholds</div>
                        <div class="row g-3">
                            <div class="col-md-4">
                                <label class="form-label">Min Confidence Score</label>
                                <input type="number" class="form-control" name="min_confidence" value="70" min="0" max="100">
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Min Followers</label>
                                <input type="number" class="form-control" name="min_followers" value="1000" min="0">
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Max Variance (%)</label>
                                <input type="number" class="form-control" name="max_variance" value="30" min="0" max="100">
                            </div>
                        </div>
                    </div>
                    
                    <div class="config-section">
                        <div class="config-section-title">Processing Settings</div>
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label">Auto-Processing</label>
                                <select class="form-control" name="auto_processing">
                                    <option value="enabled">Enabled</option>
                                    <option value="disabled">Disabled</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Batch Size</label>
                                <input type="number" class="form-control" name="batch_size" value="10" min="1" max="50">
                            </div>
                        </div>
                    </div>
                    
                    <div class="config-section">
                        <div class="config-section-title">Notification Settings</div>
                        <div class="row g-3">
                            <div class="col-md-6">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="email_notifications" checked>
                                    <label class="form-check-label">Email Notifications</label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="admin_alerts" checked>
                                    <label class="form-check-label">Admin Alerts</label>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveConfiguration()">
                    <i class="fas fa-save"></i> Save Configuration
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Processing Overlay -->
<div class="processing-overlay" id="processingOverlay">
    <div class="processing-content">
        <div class="processing-spinner"></div>
        <h6 id="processingTitle">Processing...</h6>
        <p class="text-muted mb-0" id="processingMessage">Please wait while we process your request.</p>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let selectedSubmissions = new Set();
let currentPage = 1;
let totalPages = 1;

// Initialize page
document.addEventListener('DOMContentLoaded', function() {
    loadSystemMetrics();
    startMetricsRefresh();
});

async function loadSystemMetrics() {
    try {
        const response = await fetch('/api/v1/admin/metrics/');
        if (response.ok) {
            const metrics = await response.json();
            updateMetricsDisplay(metrics);
        }
    } catch (error) {
        console.error('Error loading metrics:', error);
    }
}

function updateMetricsDisplay(metrics) {
    document.getElementById('queueStatus').textContent = `${metrics.pending_count || 0} pending`;
    document.getElementById('lastProcessTime').textContent = metrics.last_process_time || 'Never';
    document.getElementById('approvedToday').textContent = metrics.approved_today || 0;
    document.getElementById('pendingToday').textContent = metrics.pending_today || 0;
    document.getElementById('processedToday').textContent = metrics.processed_today || 0;
    document.getElementById('accuracyRate').textContent = `${metrics.accuracy_rate || 100}%`;
}

function startMetricsRefresh() {
    setInterval(loadSystemMetrics, 30000); // Refresh every 30 seconds
}

async function processAllPending() {
    if (!confirm('Process all pending submissions? This may take several minutes.')) {
        return;
    }
    
    showProcessingOverlay('Processing All Submissions', 'Processing pending submissions...');
    
    try {
        const response = await fetch('/api/v1/admin/process-all/', {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCsrfToken(),
                'Content-Type': 'application/json'
            }
        });
        
        if (response.ok) {
            const result = await response.json();
            hideProcessingOverlay();
            showNotification(`Processed ${result.processed || 0} submissions successfully`, 'success');
            loadSystemMetrics();
        } else {
            throw new Error('Failed to process submissions');
        }
    } catch (error) {
        console.error('Error processing submissions:', error);
        hideProcessingOverlay();
        showNotification('Error processing submissions', 'error');
    }
}

function showBulkManagement() {
    const section = document.getElementById('bulkManagementSection');
    section.style.display = section.style.display === 'none' ? 'block' : 'none';
    
    if (section.style.display === 'block') {
        loadSubmissionsForBulk();
    }
}

async function loadSubmissionsForBulk(page = 1) {
    try {
        const response = await fetch(`/api/v1/admin/submissions/?page=${page}&page_size=20`);
        if (response.ok) {
            const data = await response.json();
            renderSubmissionsTable(data.results || []);
            updatePagination(data.pagination || {});
        }
    } catch (error) {
        console.error('Error loading submissions:', error);
        showNotification('Error loading submissions', 'error');
    }
}

function renderSubmissionsTable(submissions) {
    const tbody = document.getElementById('submissionsTableBody');
    
    tbody.innerHTML = submissions.map(submission => `
        <tr>
            <td>
                <input type="checkbox" class="form-check-input submission-checkbox" 
                       value="${submission.id}" onchange="updateSelection()">
            </td>
            <td>${submission.id}</td>
            <td>
                <div class="d-flex align-items-center">
                    <div class="user-avatar me-2" style="width: 24px; height: 24px; background: var(--primary); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; font-size: 0.6rem;">
                        ${(submission.channel_name || 'U').charAt(0).toUpperCase()}
                    </div>
                    <div>
                        <div class="fw-semibold">${submission.channel_name || 'Unknown'}</div>
                        <small class="text-muted">${submission.author_name || ''}</small>
                    </div>
                </div>
            </td>
            <td>
                <span class="badge badge-primary">
                    ${getPlatformIcon(submission.platform)}
                    ${submission.platform}
                </span>
            </td>
            <td>${getStatusBadge(submission.status, submission.auto_approved)}</td>
            <td>${getScoreBadge(submission.approval_score)}</td>
            <td>
                <span class="text-muted">${getTimeAgo(submission.created_at)}</span>
            </td>
            <td>
                <div class="d-flex gap-1">
                    ${submission.status === 'pending' ? `
                        <button class="btn btn-outline-primary btn-sm" onclick="processSingleSubmission(${submission.id})">
                            <i class="fas fa-play"></i>
                        </button>
                    ` : ''}
                    <button class="btn btn-outline-secondary btn-sm" onclick="editSubmission(${submission.id})">
                        <i class="fas fa-edit"></i>
                    </button>
                </div>
            </td>
        </tr>
    `).join('');
}

function updateSelection() {
    const checkboxes = document.querySelectorAll('.submission-checkbox:checked');
    selectedSubmissions.clear();
    
    checkboxes.forEach(checkbox => {
        selectedSubmissions.add(parseInt(checkbox.value));
    });
    
    document.getElementById('selectedCount').textContent = selectedSubmissions.size;
    document.getElementById('bulkActionsBar').classList.toggle('show', selectedSubmissions.size > 0);
    
    // Update select all checkbox
    const allCheckboxes = document.querySelectorAll('.submission-checkbox');
    const selectAllCheckbox = document.getElementById('selectAllCheckbox');
    selectAllCheckbox.indeterminate = selectedSubmissions.size > 0 && selectedSubmissions.size < allCheckboxes.length;
    selectAllCheckbox.checked = selectedSubmissions.size === allCheckboxes.length && allCheckboxes.length > 0;
}

function toggleSelectAll() {
    const selectAll = document.getElementById('selectAllCheckbox').checked;
    const checkboxes = document.querySelectorAll('.submission-checkbox');
    
    checkboxes.forEach(checkbox => {
        checkbox.checked = selectAll;
    });
    
    updateSelection();
}

function clearSelection() {
    document.querySelectorAll('.submission-checkbox').forEach(checkbox => {
        checkbox.checked = false;
    });
    document.getElementById('selectAllCheckbox').checked = false;
    updateSelection();
}

async function bulkApprove() {
    if (selectedSubmissions.size === 0) return;
    
    if (!confirm(`Approve ${selectedSubmissions.size} selected submissions?`)) {
        return;
    }
    
    showProcessingOverlay('Bulk Approval', `Approving ${selectedSubmissions.size} submissions...`);
    
    try {
        const response = await fetch('/api/v1/admin/bulk-approve/', {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCsrfToken(),
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                submission_ids: Array.from(selectedSubmissions)
            })
        });
        
        if (response.ok) {
            const result = await response.json();
            hideProcessingOverlay();
            showNotification(`Approved ${result.approved || 0} submissions`, 'success');
            loadSubmissionsForBulk(currentPage);
            clearSelection();
            loadSystemMetrics();
        } else {
            throw new Error('Bulk approval failed');
        }
    } catch (error) {
        console.error('Error in bulk approval:', error);
        hideProcessingOverlay();
        showNotification('Error in bulk approval', 'error');
    }
}

async function bulkReject() {
    if (selectedSubmissions.size === 0) return;
    
    const reason = prompt(`Reject ${selectedSubmissions.size} submissions?\nEnter rejection reason:`);
    if (!reason) return;
    
    showProcessingOverlay('Bulk Rejection', `Rejecting ${selectedSubmissions.size} submissions...`);
    
    try {
        const response = await fetch('/api/v1/admin/bulk-reject/', {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCsrfToken(),
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                submission_ids: Array.from(selectedSubmissions),
                reason: reason
            })
        });
        
        if (response.ok) {
            const result = await response.json();
            hideProcessingOverlay();
            showNotification(`Rejected ${result.rejected || 0} submissions`, 'success');
            loadSubmissionsForBulk(currentPage);
            clearSelection();
            loadSystemMetrics();
        } else {
            throw new Error('Bulk rejection failed');
        }
    } catch (error) {
        console.error('Error in bulk rejection:', error);
        hideProcessingOverlay();
        showNotification('Error in bulk rejection', 'error');
    }
}

async function bulkProcess() {
    if (selectedSubmissions.size === 0) return;
    
    if (!confirm(`Process ${selectedSubmissions.size} selected submissions?`)) {
        return;
    }
    
    showProcessingOverlay('Bulk Processing', `Processing ${selectedSubmissions.size} submissions...`);
    
    try {
        const response = await fetch('/api/v1/admin/bulk-process/', {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCsrfToken(),
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                submission_ids: Array.from(selectedSubmissions)
            })
        });
        
        if (response.ok) {
            const result = await response.json();
            hideProcessingOverlay();
            showNotification(`Processed ${result.processed || 0} submissions`, 'success');
            loadSubmissionsForBulk(currentPage);
            clearSelection();
            loadSystemMetrics();
        } else {
            throw new Error('Bulk processing failed');
        }
    } catch (error) {
        console.error('Error in bulk processing:', error);
        hideProcessingOverlay();
        showNotification('Error in bulk processing', 'error');
    }
}

function showSystemLogs() {
    const modal = new bootstrap.Modal(document.getElementById('systemLogsModal'));
    modal.show();
    loadLogs('auto_approval');
}

async function loadLogs(logType) {
    const viewer = document.getElementById('logViewer');
    viewer.textContent = 'Loading logs...';
    
    try {
        const response = await fetch(`/api/v1/admin/logs/?type=${logType}&lines=500`);
        if (response.ok) {
            const data = await response.json();
            viewer.textContent = data.logs || 'No logs available';
        } else {
            viewer.textContent = 'Error loading logs';
        }
    } catch (error) {
        console.error('Error loading logs:', error);
        viewer.textContent = 'Error loading logs';
    }
}

function refreshLogs() {
    const selectedLogType = document.querySelector('input[name="logType"]:checked').value;
    loadLogs(selectedLogType);
}

// Log type change handlers
document.querySelectorAll('input[name="logType"]').forEach(radio => {
    radio.addEventListener('change', function() {
        if (this.checked) {
            loadLogs(this.value);
        }
    });
});

function showConfiguration() {
    const modal = new bootstrap.Modal(document.getElementById('configurationModal'));
    modal.show();
    loadCurrentConfiguration();
}

async function loadCurrentConfiguration() {
    try {
        const response = await fetch('/api/v1/admin/configuration/');
        if (response.ok) {
            const config = await response.json();
            populateConfigurationForm(config);
        }
    } catch (error) {
        console.error('Error loading configuration:', error);
    }
}

function populateConfigurationForm(config) {
    const form = document.getElementById('configurationForm');
    Object.keys(config).forEach(key => {
        const input = form.querySelector(`[name="${key}"]`);
        if (input) {
            if (input.type === 'checkbox') {
                input.checked = config[key];
            } else {
                input.value = config[key];
            }
        }
    });
}

async function saveConfiguration() {
    const form = document.getElementById('configurationForm');
    const formData = new FormData(form);
    const config = {};
    
    for (let [key, value] of formData.entries()) {
        const input = form.querySelector(`[name="${key}"]`);
        if (input.type === 'checkbox') {
            config[key] = input.checked;
        } else if (input.type === 'number') {
            config[key] = parseFloat(value);
        } else {
            config[key] = value;
        }
    }
    
    try {
        const response = await fetch('/api/v1/admin/configuration/', {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCsrfToken(),
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(config)
        });
        
        if (response.ok) {
            showNotification('Configuration saved successfully', 'success');
            bootstrap.Modal.getInstance(document.getElementById('configurationModal')).hide();
        } else {
            throw new Error('Failed to save configuration');
        }
    } catch (error) {
        console.error('Error saving configuration:', error);
        showNotification('Error saving configuration', 'error');
    }
}

async function exportData() {
    if (!confirm('Export all submission data? This may take a few moments.')) {
        return;
    }
    
    try {
        const response = await fetch('/api/v1/admin/export/', {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCsrfToken()
            }
        });
        
        if (response.ok) {
            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `submissions_export_${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
            showNotification('Data exported successfully', 'success');
        } else {
            throw new Error('Export failed');
        }
    } catch (error) {
        console.error('Error exporting data:', error);
        showNotification('Error exporting data', 'error');
    }
}

async function clearRejectedSubmissions() {
    if (!confirm('Clear all rejected submissions older than 30 days? This action cannot be undone.')) {
        return;
    }
    
    showProcessingOverlay('Clearing Rejected Submissions', 'Removing old rejected submissions...');
    
    try {
        const response = await fetch('/api/v1/admin/clear-rejected/', {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCsrfToken(),
                'Content-Type': 'application/json'
            }
        });
        
        if (response.ok) {
            const result = await response.json();
            hideProcessingOverlay();
            showNotification(`Cleared ${result.cleared || 0} rejected submissions`, 'success');
            loadSystemMetrics();
        } else {
            throw new Error('Failed to clear rejected submissions');
        }
    } catch (error) {
        console.error('Error clearing rejected submissions:', error);
        hideProcessingOverlay();
        showNotification('Error clearing rejected submissions', 'error');
    }
}

function showProcessingOverlay(title, message) {
    document.getElementById('processingTitle').textContent = title;
    document.getElementById('processingMessage').textContent = message;
    document.getElementById('processingOverlay').classList.add('show');
}

function hideProcessingOverlay() {
    document.getElementById('processingOverlay').classList.remove('show');
}

// Utility functions (same as previous files)
function getPlatformIcon(platform) {
    const icons = {
        'Telegram': '<i class="fab fa-telegram"></i>',
        'Twitter': '<i class="fab fa-twitter"></i>',
        'TikTok': '<i class="fab fa-tiktok"></i>',
        'YouTube': '<i class="fab fa-youtube"></i>',
        'Instagram': '<i class="fab fa-instagram"></i>',
        'Discord': '<i class="fab fa-discord"></i>'
    };
    return icons[platform] || '<i class="fas fa-globe"></i>';
}

function getStatusBadge(status, autoApproved) {
    if (status === 'approved') {
        return autoApproved ? 
            '<span class="badge badge-success">Auto-Approved</span>' : 
            '<span class="badge badge-success">Manual Approved</span>';
    } else if (status === 'rejected') {
        return '<span class="badge badge-danger">Rejected</span>';
    } else {
        return '<span class="badge badge-warning">Pending</span>';
    }
}

function getScoreBadge(score) {
    if (!score && score !== 0) {
        return '<span class="text-muted">-</span>';
    }
    
    if (score >= 70) {
        return `<span class="badge badge-success">${score}</span>`;
    } else if (score >= 40) {
        return `<span class="badge badge-warning">${score}</span>`;
    } else {
        return `<span class="badge badge-danger">${score}</span>`;
    }
}

function getTimeAgo(dateString) {
    const date = new Date(dateString);
    const now = new Date();
    const diffInSeconds = Math.floor((now - date) / 1000);
    
    if (diffInSeconds < 60) return 'Just now';
    if (diffInSeconds < 3600) return Math.floor(diffInSeconds / 60) + 'm ago';
    if (diffInSeconds < 86400) return Math.floor(diffInSeconds / 3600) + 'h ago';
    return Math.floor(diffInSeconds / 86400) + 'd ago';
}

function showNotification(message, type = 'info') {
    const toast = document.createElement('div');
    toast.className = `alert alert-${type === 'error' ? 'danger' : type} alert-dismissible fade show position-fixed`;
    toast.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    toast.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(toast);
    
    setTimeout(() => {
        if (toast.parentNode) {
            toast.parentNode.removeChild(toast);
        }
    }, 5000);
}

function getCsrfToken() {
    return document.querySelector('[name=csrfmiddlewaretoken]')?.value || '';
}
</script>
{% endblock %}