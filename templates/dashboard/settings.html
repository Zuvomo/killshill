{% extends 'base_dashboard.html' %}

{% block title %}Settings - KillShill{% endblock %}

{% block page_title %}Settings{% endblock %}

{% block content %}
<div class="page-header mb-4">
    <p class="page-subtitle text-muted">Manage your account preferences and connected services</p>
</div>

<div class="row">
    <div class="col-lg-8">
        <!-- Profile Settings -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">Profile Information</h5>
            </div>
            <div class="card-body">
                <form method="post" action="{% url 'dashboard:settings' %}">
                    {% csrf_token %}
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="first_name" class="form-label">First Name</label>
                            <input type="text" class="form-control" id="first_name" name="first_name" 
                                   value="{{ user.first_name }}">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="last_name" class="form-label">Last Name</label>
                            <input type="text" class="form-control" id="last_name" name="last_name" 
                                   value="{{ user.last_name }}">
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="email" class="form-label">Email Address</label>
                        <input type="email" class="form-control" id="email" name="email" 
                               value="{{ user.email }}" readonly>
                        <small class="form-text text-muted">Email cannot be changed</small>
                    </div>
                    
                    {% if profile %}
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="phone" class="form-label">Phone Number</label>
                            <input type="tel" class="form-control" id="phone" name="phone" 
                                   value="{{ profile.phone }}">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="location" class="form-label">Location</label>
                            <input type="text" class="form-control" id="location" name="location" 
                                   value="{{ profile.location }}">
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="bio" class="form-label">Bio</label>
                        <textarea class="form-control" id="bio" name="bio" rows="3">{{ profile.bio }}</textarea>
                    </div>
                    
                    <div class="mb-3">
                        <label for="website" class="form-label">Website</label>
                        <input type="url" class="form-control" id="website" name="website" 
                               value="{{ profile.website }}">
                    </div>
                    {% endif %}
                    
                    <button type="submit" class="btn btn-gradient">
                        <i class="fas fa-save me-2"></i>Save Changes
                    </button>
                </form>
            </div>
        </div>
        
        <!-- Notification Preferences -->
        {% comment %} <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">Notification Preferences</h5>
            </div>
            <div class="card-body">
                <form method="post" action="{% url 'dashboard:settings' %}">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="notifications">
                    
                    {% if profile %}
                    <div class="form-check form-switch mb-3">
                        <input class="form-check-input" type="checkbox" id="email_notifications" 
                               name="email_notifications" {% if profile.email_notifications %}checked{% endif %}>
                        <label class="form-check-label" for="email_notifications">
                            <strong>Email Notifications</strong>
                            <small class="d-block text-muted">Receive updates about your followed influencers</small>
                        </label>
                    </div>
                    
                    <div class="form-check form-switch mb-3">
                        <input class="form-check-input" type="checkbox" id="push_notifications" 
                               name="push_notifications" {% if profile.push_notifications %}checked{% endif %}>
                        <label class="form-check-label" for="push_notifications">
                            <strong>Push Notifications</strong>
                            <small class="d-block text-muted">Real-time alerts for important updates</small>
                        </label>
                    </div>
                    
                    <div class="form-check form-switch mb-3">
                        <input class="form-check-input" type="checkbox" id="newsletter_subscription" 
                               name="newsletter_subscription" {% if profile.newsletter_subscription %}checked{% endif %}>
                        <label class="form-check-label" for="newsletter_subscription">
                            <strong>Newsletter Subscription</strong>
                            <small class="d-block text-muted">Weekly market insights and platform updates</small>
                        </label>
                    </div>
                    {% endif %}
                    
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-bell me-2"></i>Update Notifications
                    </button>
                </form>
            </div>
        </div> {% endcomment %}
        
        <!-- Password Change -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">Change Password</h5>
            </div>
            <div class="card-body">
                <form method="post" action="{% url 'dashboard:settings' %}">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="password">
                    
                    <div class="mb-3">
                        <label for="current_password" class="form-label">Current Password</label>
                        <input type="password" class="form-control" id="current_password" 
                               name="current_password" required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="new_password" class="form-label">New Password</label>
                        <input type="password" class="form-control" id="new_password" 
                               name="new_password" required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="confirm_password" class="form-label">Confirm New Password</label>
                        <input type="password" class="form-control" id="confirm_password" 
                               name="confirm_password" required>
                    </div>
                    
                    <button type="submit" class="btn btn-gradient">
                        <i class="fas fa-key me-2"></i>Change Password
                    </button>
                </form>
            </div>
        </div>
    </div>
    
    <div class="col-lg-4">
        <!-- Account Status -->
        {% comment %} <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">Account Status</h5>
            </div>
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <span>Account Type:</span>
                    {% if profile and profile.is_premium %}
                        <span class="badge badge-warning">Premium</span>
                    {% else %}
                        <span class="badge badge-secondary">Free</span>
                    {% endif %}
                </div>
                
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <span>Verification Status:</span>
                    {% if profile and profile.is_verified %}
                        <span class="badge badge-success">
                            <i class="fas fa-check me-1"></i>Verified
                        </span>
                    {% else %}
                        <span class="badge badge-warning">
                            <i class="fas fa-clock me-1"></i>Pending
                        </span>
                    {% endif %}
                </div>
                
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <span>Member Since:</span>
                    <span class="text-muted">{{ user.date_joined|date:"M d, Y" }}</span>
                </div>
                
                {% if profile %}
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <span>Login Count:</span>
                    <span class="text-muted">{{ profile.login_count }}</span>
                </div>
                {% endif %}
                
                {% if not profile or not profile.is_premium %}
                <div class="mt-4">
                    <button class="btn btn-warning w-100">
                        <i class="fas fa-star me-2"></i>Upgrade to Premium
                    </button>
                </div>
                {% endif %}
            </div>
        </div> {% endcomment %}
        
        <!-- Connected Accounts -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">Connected Accounts</h5>
            </div>
            <div class="card-body">
                {% if profile %}
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <div>
                        <i class="fab fa-google text-danger me-2"></i>
                        <span>Google</span>
                    </div>
                    {% if profile.google_connected %}
                        <span class="badge badge-success">Connected</span>
                    {% else %}
                        <a href="/accounts/google/login/" class="btn btn-sm btn-outline-primary">Connect</a>
                    {% endif %}
                </div>
                
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <div>
                        <i class="fab fa-twitter text-info me-2"></i>
                        <span>Twitter</span>
                    </div>
                    {% if profile.twitter_connected %}
                        <span class="badge badge-success">Connected</span>
                    {% else %}
                        <a href="/accounts/twitter_oauth2/login/" class="btn btn-sm btn-outline-primary">Connect</a>
                    {% endif %}
                </div>
                
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <div>
                        <i class="fab fa-telegram text-primary me-2"></i>
                        <span>Telegram</span>
                    </div>
                    {% if profile.telegram_connected %}
                        <span class="badge badge-success">Connected</span>
                    {% else %}
                        <button class="btn btn-sm btn-outline-primary">Connect</button>
                    {% endif %}
                </div>
                {% endif %}
            </div>
        </div>
        
        <!-- Danger Zone -->
        <div class="card border-danger">
            <div class="card-header bg-danger text-white">
                <h5 class="mb-0">Danger Zone</h5>
            </div>
            <div class="card-body">
                <p class="text-muted">These actions cannot be undone</p>
                <button class="btn btn-gradient w-100 mb-2" data-bs-toggle="modal" data-bs-target="#deleteAccountModal">
                    <i class="fas fa-trash me-2"></i>Delete Account
                </button>
                {% comment %} <button class="btn btn-outline-warning w-100" onclick="exportData()">
                    <i class="fas fa-download me-2"></i>Export Data
                </button> {% endcomment %}
            </div>
        </div>
    </div>
</div>

<!-- Delete Account Modal -->
<div class="modal fade" id="deleteAccountModal" tabindex="-1" aria-labelledby="deleteAccountModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content bg-dark border-danger">
            <div class="modal-header border-danger">
                <h5 class="modal-title text-danger" id="deleteAccountModalLabel">
                    <i class="fas fa-exclamation-triangle me-2"></i>Delete Account
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="post" action="{% url 'dashboard:settings' %}">
                <div class="modal-body">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="delete_account">
                    
                    <div class="alert alert-danger">
                        <h6><i class="fas fa-warning me-2"></i>This action cannot be undone!</h6>
                        <p class="mb-0">Deleting your account will permanently remove:</p>
                        <ul class="mt-2 mb-0">
                            <li>Your profile and personal information</li>
                            <li>Your watchlist and preferences</li>
                            <li>Your submitted influencer data</li>
                            <li>All activity history</li>
                        </ul>
                    </div>
                    
                    <div class="mb-3">
                        <label for="current_password_delete" class="form-label">Current Password</label>
                        <input type="password" class="form-control" id="current_password_delete" 
                               name="current_password_delete" required>
                        <small class="form-text text-muted">Enter your password to confirm your identity</small>
                    </div>
                    
                    <div class="mb-3">
                        <label for="delete_confirmation" class="form-label">Type "DELETE" to confirm</label>
                        <input type="text" class="form-control" id="delete_confirmation" 
                               name="delete_confirmation" placeholder="Type DELETE here" required>
                        <small class="form-text text-muted">This confirms you understand the consequences</small>
                    </div>
                </div>
                <div class="modal-footer border-danger">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-danger" id="confirmDeleteBtn" disabled>
                        <i class="fas fa-trash me-2"></i>Delete My Account
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Form validation
document.addEventListener('DOMContentLoaded', function() {
    // Password confirmation validation
    const passwordForm = document.querySelector('form[action*="settings"] input[name="action"][value="password"]')?.closest('form');
    if (passwordForm) {
        passwordForm.addEventListener('submit', function(e) {
            const newPassword = document.getElementById('new_password').value;
            const confirmPassword = document.getElementById('confirm_password').value;
            
            if (newPassword !== confirmPassword) {
                e.preventDefault();
                alert('New passwords do not match!');
            }
            
            if (newPassword.length < 8) {
                e.preventDefault();
                alert('Password must be at least 8 characters long!');
            }
        });
    }
    
    // Delete account confirmation validation
    const deleteConfirmInput = document.getElementById('delete_confirmation');
    const deletePasswordInput = document.getElementById('current_password_delete');
    const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');
    
    function checkDeleteFormValidity() {
        const confirmationText = deleteConfirmInput.value.trim().toUpperCase();
        const hasPassword = deletePasswordInput.value.trim().length > 0;
        
        confirmDeleteBtn.disabled = !(confirmationText === 'DELETE' && hasPassword);
    }
    
    if (deleteConfirmInput && deletePasswordInput && confirmDeleteBtn) {
        deleteConfirmInput.addEventListener('input', checkDeleteFormValidity);
        deletePasswordInput.addEventListener('input', checkDeleteFormValidity);
        
        // Reset form when modal is closed
        document.getElementById('deleteAccountModal').addEventListener('hidden.bs.modal', function() {
            deleteConfirmInput.value = '';
            deletePasswordInput.value = '';
            confirmDeleteBtn.disabled = true;
        });
        
        // Final confirmation before submission
        confirmDeleteBtn.addEventListener('click', function(e) {
            e.preventDefault();
            if (confirm('Are you absolutely sure? This action cannot be undone and will permanently delete your account.')) {
                confirmDeleteBtn.closest('form').submit();
            }
        });
    }
});
</script>
{% endblock %}